<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Design Tab - WebContainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 12px 20px;
            border-bottom: 1px solid #2a2a3e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-idle { background: #2a2a3e; color: #888; }
        .status-booting { background: #3b4903; color: #d4e815; }
        .status-processing { background: #1e3a5f; color: #64b5f6; }
        .status-installing { background: #4a148c; color: #ce93d8; }
        .status-starting { background: #e65100; color: #ffcc80; }
        .status-ready { background: #1b5e20; color: #81c784; }
        .status-error { background: #b71c1c; color: #ef5350; }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            background: #2a2a3e;
            border: 1px solid #3a3a4e;
            color: #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: #3a3a4e;
            border-color: #4a4a5e;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn.active {
            background: #667eea;
            border-color: #667eea;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-content {
            flex: 1;
            position: relative;
            background: #0f0f0f;
        }

        .preview-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #previewFrame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            display: none;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #888;
        }

        .empty-state p {
            font-size: 16px;
            color: #555;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid #2a2a3e;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        .loading-details {
            font-size: 14px;
            color: #888;
        }

        .element-selector-hint {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            z-index: 100;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -20px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .error-banner {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: #b71c1c;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(183, 28, 28, 0.3);
            z-index: 1001;
            display: none;
        }

        .footer {
            background: #1a1a2e;
            padding: 10px 20px;
            border-top: 1px solid #2a2a3e;
            display: none;
        }

        .element-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .element-info code {
            background: #2a2a3e;
            padding: 4px 8px;
            border-radius: 4px;
            color: #64b5f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <span style="font-size: 20px;">ðŸš€</span>
                <h1 style="font-size: 18px; font-weight: 600;">Ghost Design Canvas</h1>
                <span id="status" class="status-badge status-idle">Idle</span>
            </div>
            <div class="controls">
                <button id="elementPickerBtn" class="btn" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 2l12 12M14 2l-12 12"/>
                    </svg>
                    Element Picker
                </button>
                <button id="refreshBtn" class="btn" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 8a6 6 0 1 0 12 0M14 8a6 6 0 1 0-12 0"/>
                    </svg>
                    Refresh
                </button>
                <button id="newTabBtn" class="btn" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="10" height="10" rx="1"/>
                        <path d="M7 7l6-6M13 3v4h-4"/>
                    </svg>
                    Open in New Tab
                </button>
                <button id="deployBtn" class="btn btn-primary" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 2v8M4 6l4 4 4-4M2 14h12"/>
                    </svg>
                    Deploy to Netlify
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="preview-container">
                <!-- Empty State -->
                <div id="emptyState" class="empty-state">
                    <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z"/>
                    </svg>
                    <h2>Ready for Ghost Output</h2>
                    <p>Ask Ghost to create an app and it will appear here automatically</p>
                </div>

                <!-- Preview Frame -->
                <iframe id="previewFrame"></iframe>

                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Preparing WebContainer...</div>
                    <div id="loadingDetails" class="loading-details">Initializing environment</div>
                </div>
            </div>

            <!-- Element selector hint -->
            <div id="elementSelectorHint" class="element-selector-hint">
                Click any element in the preview to select and edit it
            </div>

            <!-- Error banner -->
            <div id="errorBanner" class="error-banner" style="display: none;"></div>
        </div>

        <!-- Footer (hidden initially) -->
        <div id="footer" class="footer">
            <div class="element-info">
                <span>Selected:</span>
                <code id="selectedElement">None</code>
            </div>
        </div>
    </div>

    <!-- Load WebContainer API directly -->
    <script type="module">
        // Import WebContainer API
        import { WebContainer } from 'https://unpkg.com/@webcontainer/api@1.1.9/dist/index.js';
        
        // Make it available globally
        window.WebContainer = WebContainer;
        console.log('WebContainer API loaded directly');
    </script>
    
    <!-- Main Application Script -->
    <script>
        // UI Elements
        const statusBadge = document.getElementById('status');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingDetails = document.getElementById('loadingDetails');
        const emptyState = document.getElementById('emptyState');
        const previewFrame = document.getElementById('previewFrame');
        const elementPickerBtn = document.getElementById('elementPickerBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const newTabBtn = document.getElementById('newTabBtn');
        const deployBtn = document.getElementById('deployBtn');
        const elementSelectorHint = document.getElementById('elementSelectorHint');
        const errorBanner = document.getElementById('errorBanner');
        const footer = document.getElementById('footer');
        const selectedElementText = document.getElementById('selectedElement');

        let webContainer = null;
        let currentFiles = {};
        let isElementPickerActive = false;
        let currentPreviewUrl = null;

        // Initialize WebContainer
        async function initWebContainer() {
            try {
                updateStatus('booting', 'Loading WebContainer...');
                
                // Use WebContainer directly
                if (!window.WebContainer) {
                    console.error('WebContainer API not loaded');
                    throw new Error('WebContainer API not found');
                }
                
                // Boot WebContainer
                webContainer = await window.WebContainer.boot();
                
                if (!webContainer) {
                    throw new Error('Failed to boot WebContainer');
                }
                
                updateStatus('ready', 'Ready');
                console.log('âœ… WebContainer initialized successfully');
                
                // Setup server ready listener
                if (webContainer.on) {
                    webContainer.on('server-ready', (port, url) => {
                        console.log(`Server ready on port ${port}: ${url}`);
                        currentPreviewUrl = url || webContainer.getUrl(port);
                        showPreview(currentPreviewUrl);
                    });
                }
                
            } catch (error) {
                console.error('Failed to initialize WebContainer:', error);
                updateStatus('error', 'Failed to initialize');
                showError('Failed to initialize WebContainer: ' + error.message);
            }
        }

        // Load app from file system path
        async function loadAppFromFileSystem(appPath, isReload = false) {
            if (!webContainer) {
                await initWebContainer();
            }
            
            try {
                updateStatus('processing', 'Loading files from ' + appPath);
                
                // Fetch file list from the container
                const response = await fetch('/api/list-files?path=' + encodeURIComponent(appPath));
                if (!response.ok) {
                    // Fallback: create a simple test app
                    console.log('Cannot access files, creating test app');
                    const files = createTestApp();
                    currentFiles = files;
                    await mountFiles(files);
                } else {
                    const fileList = await response.json();
                    const files = {};
                    
                    // Load each file
                    for (const fileName of fileList) {
                        const fileResponse = await fetch('/api/read-file?path=' + encodeURIComponent(appPath + '/' + fileName));
                        if (fileResponse.ok) {
                            const content = await fileResponse.text();
                            files[fileName] = {
                                file: {
                                    contents: content
                                }
                            };
                        }
                    }
                    
                    currentFiles = files;
                    await mountFiles(files);
                }
                
                // Install and start if not reload
                if (!isReload) {
                    if (currentFiles['package.json']) {
                        await installDependencies();
                    }
                    await startDevServer();
                } else {
                    // Just reload the preview
                    if (currentPreviewUrl) {
                        previewFrame.src = currentPreviewUrl;
                    }
                }
                
            } catch (error) {
                console.error('Error loading app from file system:', error);
                // Fallback to test app
                const files = createTestApp();
                currentFiles = files;
                await mountFiles(files);
                await installDependencies();
                await startDevServer();
            }
        }
        
        // Create a test app as fallback
        function createTestApp() {
            return {
                'package.json': {
                    file: {
                        contents: JSON.stringify({
                            name: "test-app",
                            version: "0.1.0",
                            type: "module",
                            scripts: {
                                dev: "vite",
                                build: "vite build"
                            },
                            dependencies: {
                                "react": "^18.2.0",
                                "react-dom": "^18.2.0"
                            },
                            devDependencies: {
                                "@vitejs/plugin-react": "^4.2.0",
                                "vite": "^5.0.0",
                                "typescript": "^5.0.0",
                                "@types/react": "^18.2.0",
                                "@types/react-dom": "^18.2.0"
                            }
                        }, null, 2)
                    }
                },
                'vite.config.js': {
                    file: {
                        contents: "import { defineConfig } from 'vite';\nimport react from '@vitejs/plugin-react';\n\nexport default defineConfig({\n  plugins: [react()],\n  server: { port: 3000 }\n});"
                    }
                },
                'index.html': {
                    file: {
                        contents: '<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Ghost App</title>\n</head>\n<body>\n    <div id="root"></div>\n    <script type="module" src="/src/main.tsx"><\/script>\n</body>\n</html>'
                    }
                },
                'src/main.tsx': {
                    file: {
                        contents: "import React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport App from './App';\nimport './index.css';\n\nReactDOM.createRoot(document.getElementById('root')!).render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>\n);"
                    }
                },
                'src/App.tsx': {
                    file: {
                        contents: "import React from 'react';\n\nfunction App() {\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center\">\n      <div className=\"text-center text-white\">\n        <h1 className=\"text-6xl font-bold mb-4\">ðŸš€ Ghost Builder</h1>\n        <p className=\"text-xl\">WebContainer Preview Active!</p>\n        <p className=\"mt-4 opacity-75\">Ask Ghost to create your app...</p>\n      </div>\n    </div>\n  );\n}\n\nexport default App;"
                    }
                },
                'src/index.css': {
                    file: {
                        contents: "@tailwind base;\n@tailwind components;\n@tailwind utilities;"
                    }
                },
                'tailwind.config.js': {
                    file: {
                        contents: "export default {\n  content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],\n  theme: { extend: {} },\n  plugins: []\n};"
                    }
                },
                'postcss.config.js': {
                    file: {
                        contents: "export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {}\n  }\n};"
                    }
                }
            };
        }
        
        // Process Dyad output (legacy)
        async function processDyadOutput(content) {
            if (!webContainer) {
                await initWebContainer();
            }
            
            try {
                updateStatus('processing', 'Processing files...');
                
                // Parse dyad-write tags
                const files = parseDyadWriteTags(content);
                currentFiles = files;
                
                // Mount files to WebContainer
                await mountFiles(files);
                
                // Install dependencies if package.json exists
                if (files['package.json']) {
                    await installDependencies();
                }
                
                // Start dev server
                await startDevServer();
                
            } catch (error) {
                console.error('Error processing Dyad output:', error);
                showError('Failed to process app: ' + error.message);
            }
        }

        // Parse ghost-write/dyad-write tags (supporting both for backward compatibility)
        function parseDyadWriteTags(content) {
            const files = {};
            // Support both ghost-write and dyad-write tags
            const patterns = [
                /<ghost-write\s+path="([^"]+)"[^>]*>([\s\S]*?)<\/ghost-write>/g,
                /<dyad-write\s+path="([^"]+)"[^>]*>([\s\S]*?)<\/dyad-write>/g
            ];
            
            for (const pattern of patterns) {
                let match;
                
                while ((match = pattern.exec(content)) !== null) {
                    const path = match[1];
                    const fileContent = match[2].trim();
                    files[path] = {
                        file: {
                            contents: fileContent
                        }
                    };
                }
            }
            
            // Add default files if not present
            if (!files['package.json']) {
                files['package.json'] = {
                    file: {
                        contents: JSON.stringify({
                            name: "ghost-app",
                            version: "0.1.0",
                            private: true,
                            scripts: {
                                dev: "vite",
                                build: "vite build",
                                preview: "vite preview"
                            },
                            dependencies: {
                                "react": "^18.2.0",
                                "react-dom": "^18.2.0"
                            },
                            devDependencies: {
                                "@vitejs/plugin-react": "^4.2.0",
                                "vite": "^5.0.0"
                            }
                        }, null, 2)
                    }
                };
            }
            
            if (!files['vite.config.js']) {
                files['vite.config.js'] = {
                    file: {
                        contents: `import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000
  }
});`
                    }
                };
            }
            
            if (!files['index.html']) {
                files['index.html'] = {
                    file: {
                        contents: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost App</title>
</head>
<body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"><\/script>
</body>
</html>`
                    }
                };
            }
            
            return files;
        }

        // Mount files to WebContainer
        async function mountFiles(files) {
            console.log('Mounting files to WebContainer...');
            
            // Ensure WebContainer is initialized
            if (!webContainer) {
                console.log('WebContainer not initialized, initializing now...');
                await initWebContainer();
            }
            
            if (webContainer && webContainer.mount) {
                await webContainer.mount(files);
            } else if (webContainer) {
                // Fallback for simple container
                console.log('Using fallback mount method');
                webContainer.files = files;
            } else {
                console.error('WebContainer still not available');
                throw new Error('WebContainer not available');
            }
        }

        // Install dependencies
        async function installDependencies() {
            updateStatus('installing', 'Installing dependencies...');
            
            if (webContainer.spawn) {
                const installProcess = await webContainer.spawn('npm', ['install']);
                
                if (installProcess.output) {
                    installProcess.output.pipeTo(new WritableStream({
                        write(data) {
                            console.log(data);
                        }
                    }));
                }
                
                const exitCode = await installProcess.exit;
                if (exitCode !== 0) {
                    throw new Error(`npm install failed with exit code ${exitCode}`);
                }
            }
        }

        // Start dev server
        async function startDevServer() {
            updateStatus('starting', 'Starting dev server...');
            
            if (webContainer.spawn) {
                const serverProcess = await webContainer.spawn('npm', ['run', 'dev']);
                
                if (serverProcess.output) {
                    serverProcess.output.pipeTo(new WritableStream({
                        write(data) {
                            console.log(data);
                        }
                    }));
                }
            } else if (webContainer.iframe) {
                // Fallback for simple container
                document.getElementById('previewFrame').replaceWith(webContainer.iframe);
                webContainer.iframe.id = 'previewFrame';
                await webContainer.mount(currentFiles);
                showPreview('about:blank');
                updateStatus('ready', 'Preview Ready');
            }
        }

        // Update status
        function updateStatus(state, message) {
            statusBadge.className = `status-badge status-${state}`;
            statusBadge.textContent = message || state;

            if (['booting', 'processing', 'installing', 'starting'].includes(state)) {
                loadingOverlay.style.display = 'flex';
                loadingDetails.textContent = message;
                emptyState.style.display = 'none';
            } else if (state === 'ready') {
                loadingOverlay.style.display = 'none';
                enableControls();
            } else if (state === 'idle') {
                loadingOverlay.style.display = 'none';
            } else if (state === 'error') {
                loadingOverlay.style.display = 'none';
            }
        }

        // Show preview
        function showPreview(url) {
            if (!webContainer.iframe) {
                previewFrame.src = url;
            }
            previewFrame.style.display = 'block';
            emptyState.style.display = 'none';
            loadingOverlay.style.display = 'none';
            enableControls();
        }

        // Show error
        function showError(message) {
            errorBanner.textContent = message;
            errorBanner.style.display = 'block';
            updateStatus('error', 'Error');
            
            setTimeout(() => {
                errorBanner.style.display = 'none';
            }, 5000);
        }

        // Enable controls
        function enableControls() {
            elementPickerBtn.disabled = false;
            refreshBtn.disabled = false;
            newTabBtn.disabled = false;
            deployBtn.disabled = false;
        }

        // Button handlers
        elementPickerBtn.addEventListener('click', () => {
            isElementPickerActive = !isElementPickerActive;
            elementPickerBtn.classList.toggle('active', isElementPickerActive);
            elementSelectorHint.style.display = isElementPickerActive ? 'block' : 'none';
            
            if (isElementPickerActive) {
                setupElementSelection();
            } else {
                teardownElementSelection();
            }
        });

        refreshBtn.addEventListener('click', () => {
            if (currentPreviewUrl) {
                previewFrame.src = currentPreviewUrl;
            }
        });

        newTabBtn.addEventListener('click', () => {
            if (currentPreviewUrl) {
                window.open(currentPreviewUrl, '_blank');
            }
        });

        deployBtn.addEventListener('click', () => {
            window.parent.postMessage({
                type: 'deploy-request',
                files: currentFiles
            }, '*');
        });

        // Element selection
        function setupElementSelection() {
            previewFrame.contentWindow.postMessage({
                type: 'enable-element-selection'
            }, '*');
        }

        function teardownElementSelection() {
            previewFrame.contentWindow.postMessage({
                type: 'disable-element-selection'
            }, '*');
        }

        // Listen for messages
        window.addEventListener('message', async (event) => {
            if (event.data.type === 'prepare-webcontainer') {
                console.log('ðŸš€ Preparing WebContainer in advance...');
                updateStatus('preparing', event.data.message || 'Preparing WebContainer...');
                
                // Initialize WebContainer early
                if (!webContainer && window.WebContainer) {
                    try {
                        console.log('Booting WebContainer...');
                        webContainer = await window.WebContainer.boot();
                        console.log('âœ… WebContainer ready for instant use!');
                        updateStatus('ready', 'WebContainer ready - waiting for app code...');
                        
                        // Pre-create common project structure
                        await webContainer.fs.mkdir('/src', { recursive: true });
                        await webContainer.fs.mkdir('/public', { recursive: true });
                        
                        // Pre-install common dependencies in background
                        preInstallDependencies();
                    } catch (error) {
                        console.error('Failed to prepare WebContainer:', error);
                        updateStatus('error', 'Failed to prepare WebContainer');
                    }
                }
            } else if (event.data.type === 'load-app-from-path') {
                console.log('Loading app from path:', event.data.path);
                await loadAppFromFileSystem(event.data.path, event.data.isReload);
            } else if (event.data.type === 'load-test-app') {
                console.log('Loading test app directly');
                // If no files provided, use the fallback test app
                const files = event.data.files && Object.keys(event.data.files).length > 0 
                    ? event.data.files 
                    : createTestApp();
                currentFiles = files;
                await mountFiles(files);
                await installDependencies();
                await startDevServer();
            } else if (event.data.type === 'load-dyad-output') {
                console.log('Received Dyad output (legacy)');
                await processDyadOutput(event.data.content);
            } else if (event.data.type === 'element-selected') {
                selectedElementText.textContent = event.data.selector;
                footer.style.display = 'block';
                
                // Send to parent for editing
                window.parent.postMessage({
                    type: 'element-selected-for-editing',
                    element: event.data
                }, '*');
            } else if (event.data.type === 'activate-selector') {
                elementPickerBtn.click();
            }
        });

        // Pre-install common dependencies
        async function preInstallDependencies() {
            if (!webcontainerInstance) return;
            
            try {
                // Create a minimal package.json with common deps
                const minimalPackageJson = {
                    name: "ghost-app",
                    version: "1.0.0",
                    private: true,
                    dependencies: {
                        "react": "^18.2.0",
                        "react-dom": "^18.2.0"
                    },
                    devDependencies: {
                        "@vitejs/plugin-react": "^4.0.0",
                        "vite": "^4.4.0"
                    }
                };
                
                await webcontainerInstance.fs.writeFile(
                    '/package.json',
                    JSON.stringify(minimalPackageJson, null, 2)
                );
                
                console.log('Pre-installing common dependencies...');
                const installProcess = await webcontainerInstance.spawn('npm', ['install']);
                
                installProcess.output.pipeTo(new WritableStream({
                    write(chunk) {
                        console.log('[Pre-install]', chunk);
                    }
                }));
                
                const exitCode = await installProcess.exit;
                if (exitCode === 0) {
                    console.log('âœ… Common dependencies pre-installed!');
                }
            } catch (error) {
                console.log('Pre-install skipped:', error.message);
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            console.log('Design tab loaded, waiting for WebContainer API...');
            // Don't auto-init, wait for Dyad output or prepare message
        });
    </script>
</body>
</html>